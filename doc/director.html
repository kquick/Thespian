<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-05-26 Wed 18:14 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Thespian Thespian Director Guide</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Kevin Quick &lt;quick@sparq.org&gt;" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="icon" type="image/png" href="/favicon.png" />
<link rel="stylesheet" type="text/css" href="styles/bigblow/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/bigblow/css/bigblow.css"/>
<link rel="stylesheet" type="text/css" href="styles/bigblow/css/hideshow.css"/>
<script type="text/javascript" src="styles/bigblow/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/jquery.zclip.min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/bigblow.js"></script>
<script type="text/javascript" src="styles/bigblow/js/hideshow.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Actor" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
<link href="thespian.css" rel="stylesheet" type="text/css"/>
<link href="thespian_director.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title"><a href="https://thespianpy.com"><img src="thesplogo2.png" alt="Thespian" width="50%" style="inline" /></a> Thespian Director Guide</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#h:a5d09d6f-8a45-4935-9e26-f90f303f1fc4">1. Thespian Director</a>
<ul>
<li><a href="#h:d195688d-da40-4d37-9e53-863c04c925ed">1.1. Loadable Sources</a></li>
</ul>
</li>
<li><a href="#h:b3af5450-cb9b-498e-b17d-915737ed6cbe">2. Director Functionality</a>
<ul>
<li><a href="#h:63786d9a-2c7b-4be2-a851-419232f73e6f">2.1. Invoking the Director Utility</a></li>
<li><a href="#h:17d0e6a2-a766-4a84-9851-e1d05401887e">2.2. Director Source Authority</a></li>
<li><a href="#h:c1538482-8183-405f-ac40-77689ae88e9b">2.3. Creating Source Packages</a>
<ul>
<li><a href="#h:46cb8ed2-828b-4d5b-9b00-9d6589894fba">2.3.1. Long-running Actor Systems</a></li>
<li><a href="#h:6593a443-96a5-4738-bb6f-89ca2dba32d6">2.3.2. Creating a signing key</a></li>
<li><a href="#h:e66ac423-726f-43ef-8b7c-deb8a400d01f">2.3.3. Specifying source inputs</a></li>
<li><a href="#h:11affdea-60eb-4b3e-b0aa-7ee747d5acfa">2.3.4. Versioning</a></li>
<li><a href="#h:df3462e3-de58-4a35-ab35-ec7280d71885">2.3.5. Full gensrc example</a></li>
</ul>
</li>
<li><a href="#h:0b69f371-9abb-4f8a-b8b2-3feca048d9d6">2.4. Specifying Thespian Configuration Settings</a>
<ul>
<li><a href="#h:bd6fe8f9-14e2-424c-afce-9f963ba9519f">2.4.1. Director Log Filter</a></li>
<li><a href="#h:92d51cdc-0c1a-42d6-892e-59c0f48d129c">2.4.2. Configuration confirmation</a></li>
</ul>
</li>
<li><a href="#h:e5d0da64-4179-4712-9bc8-c39963b92af6">2.5. Starting Thespian</a></li>
<li><a href="#h:23992716-881e-4aed-8790-b3b97cb5f5d9">2.6. Stopping Thespian</a></li>
<li><a href="#h:fd910797-75e7-42c7-ae9d-1ae87a4040b8">2.7. Managing loaded sources</a>
<ul>
<li><a href="#h:6476d6be-5745-47a4-a302-55744fe38d55">2.7.1. Loading the latest source versions</a></li>
<li><a href="#h:de4181e6-1c1b-461a-b8b6-bfdd605bf734">2.7.2. TLI Files</a></li>
</ul>
</li>
<li><a href="#h:306175d7-4db6-4e47-b035-86efa491b3e0">2.8. Director API</a></li>
</ul>
</li>
<li><a href="#h:712ee97c-25b7-4c23-8409-167a2c567bdd">3. Considerations for using Loadable Sources</a>
<ul>
<li><a href="#h:1898efa0-a1d4-4415-92e0-8232b2b5285f">3.1. Source Package limitations</a></li>
<li><a href="#h:1e8b3963-5daa-4ea5-9067-25bde3580b80">3.2. Logging callables not supported</a></li>
<li><a href="#h:423373f2-9638-4b96-80a5-a57abe94f134">3.3. Communication across package boundaries</a></li>
<li><a href="#h:29d0f65c-db9f-4d8c-893b-0711958ed792">3.4. Actor specifications for createActor</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org72c6a03" class="outline-2">
<h2 id="h:a5d09d6f-8a45-4935-9e26-f90f303f1fc4"><a id="org72c6a03"></a><span class="section-number-2">1</span> Thespian Director</h2>
<div class="outline-text-2" id="text-h:a5d09d6f-8a45-4935-9e26-f90f303f1fc4">
<p>
As described in the <a href="using.html">Using Thespian</a> document, it is possible to use the
Thespian Director utility to assist in working with loadable Actor
sources.  This document describes the Director and associated loading
functionality in detail.
</p>

<p>
It is possible to use the loadable source functionality without using
the Thespian Director, but it is much easier when using the common
functionality provided by the Director.
</p>
</div>

<div id="outline-container-orgd52cb01" class="outline-3">
<h3 id="h:d195688d-da40-4d37-9e53-863c04c925ed"><a id="orgd52cb01"></a><span class="section-number-3">1.1</span> Loadable Sources</h3>
<div class="outline-text-3" id="text-h:d195688d-da40-4d37-9e53-863c04c925ed">
<p>
As a review, loadable Actor sources provide a method for hot-updates
of the Actor source code and possibly running multiple versions of the
sources in parallel.  This has a number of advantages:
</p>

<ul class="org-ul">
<li>The sources only need to be loaded into the leading ActorSystem;
all other ActorSystems will update from the leading system
automatically on an as-needed basis.  This also alleviates the
need to restart the ActorSystem on the remote nodes each time the
source is updated.</li>

<li>Multiple versions of the sources can be running simultaneously.
One use case for this is allowing the older sources to continue
running the requests submitted to that source while directing all
new requests to the newer version.  The older sources can be
unloaded at a later time after all of the in-progress requests
have been completed.</li>

<li>Loaded sources are validated by the Source Authority, which can
use cryptographic signature validation of the sources, increasing
the overall security of the system.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgd6f5567" class="outline-2">
<h2 id="h:b3af5450-cb9b-498e-b17d-915737ed6cbe"><a id="orgd6f5567"></a><span class="section-number-2">2</span> Director Functionality</h2>
<div class="outline-text-2" id="text-h:b3af5450-cb9b-498e-b17d-915737ed6cbe">
<p>
The Thespian Director is made up of several components:
</p>

<ol class="org-ol">
<li>A command-line interface allowing configuration and management of
the loadable sources.</li>

<li>A source package creator that generates a signed, loadable source
package from a set of inputs.</li>

<li>A Director Actor which maintains a list of the currently loaded
sources and assists in loading new sources.</li>

<li>A Source Authority Actor which validates loaded sources.</li>

<li>Configuration specifications for starting up a Thespian ActorSystem
with various configuration settings.  These specifications are
designed to be easily updated via automated means to support simple
configuration updates across an entire environment.

<ul class="org-ul">
<li>This includes configuration of the logging subsystem for Thespian
interaction.</li>
</ul></li>

<li>Common logging filter function to ensure logging can display actor
addresses consistently.</li>

<li>Thespian startup using the specified configuration settings.  This
startup can be performed on demand or it can be configured to be
started at system boot time for systemd, initctl, and Windows-based
operating systems.</li>
</ol>
</div>

<div id="outline-container-org63f0966" class="outline-3">
<h3 id="h:63786d9a-2c7b-4be2-a851-419232f73e6f"><a id="org63f0966"></a><span class="section-number-3">2.1</span> Invoking the Director Utility</h3>
<div class="outline-text-3" id="text-h:63786d9a-2c7b-4be2-a851-419232f73e6f">
<p>
The Thespian Director is easily invoked from the command line via the
Python module specification syntax:
</p>

<pre class="example">
$ python -m thespian.director [verbose] [command [args...]]
</pre>

<p>
When invoked with no command, the Director will output help
information to stdout but take no other action.  This can be used to
quickly determine what the needed command is or the overall settings
are.
</p>

<p>
The Director takes several primary commands, and each has a different
set of arguments.  The "help" command will print the same information
as when specifying no command, but following the help command with the
name of another command will print help information specific to that
second command.
</p>

<p>
When invoked, the Director will typically look for various local files
specifying configuration settings and loadable sources.  It is
customary to setup a single directory to contain all of these files,
and the Director uses the <code>THESPIAN_DIRECTOR_DIR</code> environment variable
to locate this directory; if not set, the directory defaults to
"<code>/opt/thespian/director</code>" under Unix or "<code>C:thespian\director</code>" under
Windows.
</p>
</div>
</div>

<div id="outline-container-org37218c4" class="outline-3">
<h3 id="h:17d0e6a2-a766-4a84-9851-e1d05401887e"><a id="org37218c4"></a><span class="section-number-3">2.2</span> Director Source Authority</h3>
<div class="outline-text-3" id="text-h:17d0e6a2-a766-4a84-9851-e1d05401887e">
<p>
One of the primary purposes of the Director is to support the ability
to dynamically load new Actor sources into a running Thespian
ActorSystem (or a Convention of ActorSystems).  In order to safely
load these sources and provide appropriate security, Thespian will not
use any loaded source unless the registered Source Authority indicates
that the source has been validated.
</p>

<p>
The Director provides a Source Authority actor that will register as
the validator of these packages.  The Source Authority will ensure
that the loaded source package was generated by the Director itself
(see the next section) and that the source itself is signed by a
cryptographic key that validates the provenance of the source and that
the source has not been modified after it was signed.  To do this, the
Source Authority will read any public key files (named "<code>*_tls.key</code>")
found in the <code>THESPIAN_DIRECTOR_DIR</code> location and use these to verify
the loaded sources.  There may be multiple key files and these key
files are read dynamically each time a source is loaded; as long as a
source can be validated by one of the key files, it will be accepted.
</p>

<p>
The Director's Source Authority is started automatically when the
Thespian ActorSystem is started by the Director.  Other than ensuring
the correct key files are available in the Director's operational
directory there is no configuration or ongoing management needed for
the Source Authority.
</p>
</div>
</div>

<div id="outline-container-orgf0a627b" class="outline-3">
<h3 id="h:c1538482-8183-405f-ac40-77689ae88e9b"><a id="orgf0a627b"></a><span class="section-number-3">2.3</span> Creating Source Packages</h3>
<div class="outline-text-3" id="text-h:c1538482-8183-405f-ac40-77689ae88e9b">
<p>
In order to create a loadable source, the varous Python files must be
packaged into a ZIP file, and that ZIP file should be prepared for
validation by the Source Authority.  This preparation process will
modify the ZIP file, making it invalid in such a way that it can only
be restored and used if the Source Authority successfully validates
the loaded file.
</p>

<p>
The preparation process will then sign the sources with a
locally-specified private key file.  The public key corresponding to
this private key must be placed in the Directors operational directory
on each system where the loaded sources may be utilized (each
ActorSystem in a convention will independently validate the loaded
sources when utilized).  The private key should <b>not</b> be distributed
in this manner: any entity possessing the private key can create a
loadable source that will be accepted by the Source Authority.  The
private key should only be accessible to the system where the loadable
sources are built or generated.
</p>
</div>

<div id="outline-container-org3dfd989" class="outline-4">
<h4 id="h:46cb8ed2-828b-4d5b-9b00-9d6589894fba"><a id="org3dfd989"></a><span class="section-number-4">2.3.1</span> Long-running Actor Systems</h4>
<div class="outline-text-4" id="text-h:46cb8ed2-828b-4d5b-9b00-9d6589894fba">
<p>
The overall operational concept of using the Director and associated
loadable sources is that the Thespian ActorSystem is started up at
boot time or the first time it is needed, but that it is thereafter
left active on the system.  The individual sets of Actors that are
needed are loaded as a source package when that need arises.  Loaded
sources may be unloaded when no longer needed, and newer versions can
be loaded, all without shutting down the ActorSystem itself.
</p>

<p>
Multiple different Actor source packages can be loaded at any one
time.  Those packages can be newer versions of existing packages, or
they can be completely independent packages.  This allows multiple
different and independent Actor-based applications to be run without
requiring consolidation or combination of those applications.  Each
application can even be independently generated using a separate
private key: as long as one of the public keys available to the
running Director Source Authority matches the loaded source that
loadable source will be useable.
</p>

<p>
Each source package will be identified by a "group" name; a newer
package that should replace an older package will have the same group
name, but independent packages will have different group names.
</p>

<p>
Older loaded sources can be unloaded on-demand or automatically based
on configuration specifications discussed in later parts of this
document.
</p>
</div>
</div>


<div id="outline-container-orgde6c600" class="outline-4">
<h4 id="h:6593a443-96a5-4738-bb6f-89ca2dba32d6"><a id="orgde6c600"></a><span class="section-number-4">2.3.2</span> Creating a signing key</h4>
<div class="outline-text-4" id="text-h:6593a443-96a5-4738-bb6f-89ca2dba32d6">
<p>
The customary way to create a key pair for signing sources is to use
the openssl toolset.  As an example:
</p>

<pre class="example">
$ openssl genrsa -out sourcekey.pem 1024
$ openssl rsa -in sourcekey.pem -pubout -out sourcekey_tls.key
</pre>

<p>
This would create a 1024-bit private key file <code>sourcekey.pem</code>, and an
associated public key file <code>sourcekey_tls.key</code>.  The public key file
would be installed in the <code>THESPIAN_DIRECTOR_DIR</code> location on all target
machines, and the private key file is used to sign the generated
loadable sources.
</p>

<p>
There are many parameters that can be used when creating a keypair;
please consult the openssl documentation for more information.
</p>
</div>
</div>

<div id="outline-container-orgd927496" class="outline-4">
<h4 id="h:e66ac423-726f-43ef-8b7c-deb8a400d01f"><a id="orgd927496"></a><span class="section-number-4">2.3.3</span> Specifying source inputs</h4>
<div class="outline-text-4" id="text-h:e66ac423-726f-43ef-8b7c-deb8a400d01f">
<p>
Once a keypair has been created (which is usually a one-time
operation), signed loadable source packages can be generated using the
"gensrc" Thespian Director command:
</p>

<pre class="example">
$ python -m thespian.director gensrc ...
</pre>

<p>
The specific set of arguments are summarized by the help information
output for this command:
</p>

<pre class="example">
$ python -m thespian.director help gensrc
</pre>

<p>
One parameter is the <code>sources_dir</code>, which specifies the root path to
the sources.  All loaded sources are expected to be found underneath
this root directory path, and this directory path will <b>not</b> be part
of the file tree existing within the loadable ZIP file.
</p>

<p>
One or more source files must be specified to be included in the ZIP
file.  Each of these source specifications can use the Python
<code>glob.glob</code> specification syntax, but remember to use quotes to avoid
conflicts with shell wildcard expansion (note: Thespian versions after
3.8.3 running under Python 3.5 or later can use the "**" glob
specification to recurse into subdirectores).  Alternatively, each
file can be explicitly specified and shell wildcarding can apply.
</p>

<p>
In addition to local files, dependent packages can be included in the
ZIP file as well.  To specify the list of packages that should be
included, create a file that lists the names of these packages, one
per line.  Unlike a pip requirements file, there should be no
specification of package versions: the gensrc does not download
packages but instead collects the named packages as previously
installed into the local environment, so this file should be viewed as
a complement to whatever tool/specification is used to install those
packages.  Having a separate package list also allows a distinction
between packages needed for the running Actor application and which
should be included in the loadable sources as separate from any
packages installed to facilitate local debugging (e.g. pyflake) which
are not needed at runtime by the Actors.  This dependency file is
provided to gensrc as an additional argument, identified by the
"deps:" prefix.
</p>

<p>
Each loadable source group also uses an information file that
specifies the runtime behavior and configuration of the loadable
source group should be handled by the Director.  This information file
is called a "TLI" file and it is described in more detail along with
the corresponding functionality in the sections below.  The TLI file
is specified to the "gensrc" command as an additional argument,
identified by the "tli:" prefix.
</p>
</div>
</div>

<div id="outline-container-orgc04c847" class="outline-4">
<h4 id="h:11affdea-60eb-4b3e-b0aa-7ee747d5acfa"><a id="orgc04c847"></a><span class="section-number-4">2.3.4</span> Versioning</h4>
<div class="outline-text-4" id="text-h:11affdea-60eb-4b3e-b0aa-7ee747d5acfa">
<p>
One of the arguments to the gensrc command specifies the version of
the loadable source file.  As described earlier, updated sources can
be loaded to replace older versions of those sources.  To identify
which loadable sources are newer than others within a group, the
"version" of the loadable source file is used.
</p>

<p>
The Thespian Director allows a version to be specified on the gensrc
command line as an additional argument identified by the "version:"
prefix.  Thespian will use a numerical sorting algorithm for each
field, where fields are separated by periods to determine which
versions are "greater" or "lesser" than other versions.  The "avail"
command (described in later sections) can be used to see what order
the Director perceives the existing versioned files to be in.
</p>

<p>
The word "date" can be used as a special version; the actual version
applied to the loadable source file generated will have an ISO date
format of "YYYYMMDDHHMM".  This form is advantageous in that the
resulting versions will sort in the same order as the gensrc commands
were chronologically run, which is usually the proper sense of code
progression.  Although it is perfectly reasonable to distribute
loadable sources using date-based versions, one common usage pattern
is to use dates during development processes and then use the actual
software release version (based on whatever local versioning scheme is
used) at release time.  The date-based versions create very large
numbers which are almost always larger than any normal product
versioning scheme, ensuring that local development builds are
preferred over production releases without requiring frequent
production version updates during that development.
</p>

<p>
It is also possible to generate loadable sources without assigning a
version, but this precludes the ability to load multiple versions of
the same source at the same time.
</p>
</div>
</div>

<div id="outline-container-orgaf0b780" class="outline-4">
<h4 id="h:df3462e3-de58-4a35-ab35-ec7280d71885"><a id="orgaf0b780"></a><span class="section-number-4">2.3.5</span> Full gensrc example</h4>
<div class="outline-text-4" id="text-h:df3462e3-de58-4a35-ab35-ec7280d71885">
<p>
The following is a hypothetical project tree for an Actor-based application:
</p>

<pre class="example">
/home/joedev/projects/foo/setup.py
                         /__init__.py
                         /fooactor.py
                         /subdir1/__init__.py
                         /subdir1/baractor.py
                         /subdir2/__init__.py
                         /subdir2/barn/__init__.py
                         /subdir2/barn/cowactor.py
                         /subdir2/barn/pigactor.py
                         /requirements.txt
                         /deppkgs.txt
                         /foo.tli
</pre>

<p>
The <code>requirements.txt</code> file is a typical specification that allows the
<code>pip</code> tool to install the local dependent packages:
</p>

<pre class="example">
$ cat requirements.txt
tabulate==0.75
jsonschema==2.5.1
Jinja2==2.9.*
pytest
pytest-benchmark &gt;= 3.0
$
</pre>

<p>
The <code>deppkgs.txt</code> file is used to specify the package dependencies for
the Thespian loadable source (which does not include the test packages):
</p>

<pre class="example">
$ cat deppkgs.txt
tabulate
jsonschema
Jinja2
$
</pre>

<p>
A loadable source package using a date-based version can be created
with the following command:
</p>

<pre class="example">
$ cd /home/joedev/projects

$ ls /opt/thespian/director
sourcekey_tls.key

$ python -m thespian.director gensrc foo /home/joedev/sourcekey.pem \
         /home/joedev/projects version:date \
         deps:./deppkgs.txt \
         foo/*.py $(find foo/subdir1 -name '*.py') 'foo/subdir2/**/*.py'

$ ls /opt/thespian/director
foo-201710261902.tls foo.tli sourcekey_tls.key

$
</pre>

<p>
The tls file that was generated will contain the python files from
<code>/home/joedev/projects/foo</code>, as well as the <code>tabulate</code>, <code>jsonschema</code>,
and <code>Jinja2</code> packages.  The tls file is therefore a fully
self-contained actor application.
</p>

<p>
A .tls file can be verified by using the <code>tlsinfo</code> Director command:
</p>

<pre class="example">
$ python -m thespian.director tlsinfo /opt/thespian/director/foo-201710261902.tls
Validated "/opt/thespian/director/foo-201710261902.tls" loadable with key /opt/thespian/director/sourcekey_tls.key

$
</pre>

<p>
This ensures that the provided public key can be used by the
Director's Source Authority to successfully validate the .tls loadable
source file.
</p>

<p>
The table-of-contents of a .tls file can be obtained as well by adding
the argument "contents", and the source of a particular loaded file
can be obtained by specifying that filename as an argument.
</p>

<pre class="example">
$ python -m thespian.director tlsinfo /opt/thespian/director/foo-201710261902.tls contents
   4317 foo/fooactor.py
    111 foo/__init__.py
  62315 foo/subdir1/baractor.py
   ...

$ python -m thespian.director tlsinfo /opt/thespian/director/foo-201710261902.tls foo/fooactor.py
import sys
import os
import jsonschema

main_schema = 'blah'
...

$
</pre>

<p>
These commands can help ensure that the loadable source package contains the expected contents.
</p>
</div>
</div>
</div>


<div id="outline-container-org99643ad" class="outline-3">
<h3 id="h:0b69f371-9abb-4f8a-b8b2-3feca048d9d6"><a id="org99643ad"></a><span class="section-number-3">2.4</span> Specifying Thespian Configuration Settings</h3>
<div class="outline-text-3" id="text-h:0b69f371-9abb-4f8a-b8b2-3feca048d9d6">
<p>
One of the Director's capabilities is being able to startup the
Thespian ActorSystem on the local host to be able to run the Actor
applications.  In order to properly start the ActorSystem, the
Director needs the set of configuration parameters that should be used
for that startup.
</p>

<p>
The configuration elements used for the ActorSystem are read from
files in the <code>THESPIAN_DIRECTOR_DIR</code> directory.  These configuration
elements are <b>not</b> in a "config.ini" style file, nor are they JSON,
YAML, or any other encoding.  Instead, each configuration value is
maintained in a separate file whose contents can simply be read and
directly used as a Python value.  This is done to make it easy to
update these configuration files via automated means: no existing
configuration format must be read and partially manipulated: simply
re-write an entire file with the new configuration value.
</p>

<p>
The configuration files and their usage are described by running the
<code>help</code> command for the Director:
</p>

<pre class="example">
$ python -m thespian.director help
</pre>

<p>
Here is an example that specifies a remote convention leader, a local
set of capabilities, a logging configuration, and a logging directory.
</p>

<pre class="example">
$ ls $THESPIAN_DIRECTOR_DIR
convleader.cfg othercaps.cfg thesplog.cfg thesplogd.cfg

$ cat convleader.cfg
192.168.32.19

$ cat othercaps.cfg
{ 'Worker': True, 'Slot': 19, 'nproc': 2 }

$ cat thesplog.cfg
{ 'version': 1,
  'formatters': {
    'normal': {
      'format': '%(asctime)s,%(msecs)d %(actorAddress)s/PID:%(process)d %(name)s %(levelname)s %(message)s',
      'datefmt': '%Y-%m-%d %H:%M:%S'
    }
  },
  'root': {'level': 20, 'handlers': ['foo_log_handler']},
  'loggers': {
    'subsysA': {'level':30, 'propagate': 0, 'handlers': ['foo_log_handler']}
  },
  'handlers': {
    'foo_log_handler': {
       'filename': 'fooapp.log',
       'class': 'logging.handlers.TimedRotatingFileHandler', 
       'formatter': 'normal', 
       'level': 20, 'backupCount':3, 
       'filters': ['isActorLog'], 
       'when': 'midnight'
    }
  },
  'filters': {'isActorLog': {'()': 'thespian.director.ActorAddressLogFilter'}}
}

$ cat thesplogd.cfg
/tmp/log

$
</pre>
</div>

<div id="outline-container-org7a775cb" class="outline-4">
<h4 id="h:bd6fe8f9-14e2-424c-afce-9f963ba9519f"><a id="org7a775cb"></a><span class="section-number-4">2.4.1</span> Director Log Filter</h4>
<div class="outline-text-4" id="text-h:bd6fe8f9-14e2-424c-afce-9f963ba9519f">
<p>
As seen in the example configuration in the previous section, the
<code>thespian.director.ActorAddressLogFilter</code> can be specified as the
filter for logging.  This filter is a convenience filter supplied by
the Director which ensures that the <code>actorAddress</code> formatting
parameter is defined for messages (see above example).  This parameter
will contain the address of the Actor which generated the message, or
an empty string if the message did not come from an Actor.
</p>
</div>
</div>

<div id="outline-container-org86d80cd" class="outline-4">
<h4 id="h:92d51cdc-0c1a-42d6-892e-59c0f48d129c"><a id="org86d80cd"></a><span class="section-number-4">2.4.2</span> Configuration confirmation</h4>
<div class="outline-text-4" id="text-h:92d51cdc-0c1a-42d6-892e-59c0f48d129c">
<p>
The <code>config</code> Director command can be used to echo various information
about the configuration observed by the Director:
</p>

<pre class="example">
$ python -m thespian.director config
   Sources location: /opt/thespian/director/
        System Base: multiprocTCPBase
         Admin Port: 1900
  Logging directory: /tmp/log
 Other Capabilities: { "Worker": True, "Slot": 19, "nproc": 2 }

$
</pre>

<p>
This command can be used to verify where the Director is looking for
configuration information and that it is able to parse the basic
configuration specifications correctly.
</p>
</div>
</div>
</div>

<div id="outline-container-orga9f1fb9" class="outline-3">
<h3 id="h:e5d0da64-4179-4712-9bc8-c39963b92af6"><a id="orga9f1fb9"></a><span class="section-number-3">2.5</span> Starting Thespian</h3>
<div class="outline-text-3" id="text-h:e5d0da64-4179-4712-9bc8-c39963b92af6">
<p>
The Director can be used to start the local Thespian ActorSystem either
on-demand or at boot time.  The startup will use the configuration
parameters defined in the configuration files described above, and the
startup will have no effect if an ActorSystem is already running.
</p>

<p>
To manually start:
</p>

<pre class="example">
$ python -m thespian.director start
</pre>

<p>
To configure Thespian to be started at boot time:
</p>

<pre class="example">
$ python -m thespian.director bootstart
</pre>

<p>
Note that the latter command will also start Thespian immediately as
well unless the word "nostart" appears on the line after the bootstart
command.  There may also be a name argument after the bootstart (and
before the "nostart" argument) which will specify the name to assign
to the system service associated with the Thespian ActorSystem started
at boot time; the default is "thespian.director".
</p>

<p>
The boot configuration automatically detects the current system's
startup manager and writes the appropriate files to the appropriate
locations.  Currently supported system managers are: systemd, initctl,
and Windows Boot Manager.
</p>
</div>
</div>

<div id="outline-container-org4cae7e7" class="outline-3">
<h3 id="h:23992716-881e-4aed-8790-b3b97cb5f5d9"><a id="org4cae7e7"></a><span class="section-number-3">2.6</span> Stopping Thespian</h3>
<div class="outline-text-3" id="text-h:23992716-881e-4aed-8790-b3b97cb5f5d9">
<p>
A running Thespian Actor System can be stopped with the <code>shutdown</code>
Director command:
</p>

<pre class="example">
$ python -m thespian.director shutdown
</pre>

<p>
This will cause all Actors to receive an ActorExitRequest and the
Actor System itself to shutdown, just as if the
<code>ActorSystem().shutdown()</code> method had been called.
</p>
</div>
</div>

<div id="outline-container-orga9c46f4" class="outline-3">
<h3 id="h:fd910797-75e7-42c7-ae9d-1ae87a4040b8"><a id="orga9c46f4"></a><span class="section-number-3">2.7</span> Managing loaded sources</h3>
<div class="outline-text-3" id="text-h:fd910797-75e7-42c7-ae9d-1ae87a4040b8">
<p>
The source files generated by the 'gensrc' command (described above)
can be loaded into the current Thespian ActorSystem and run.  The
Director can be used to load individual sources on-demand, or load the
latest version of each source in every group.
</p>

<p>
To load a single source, specify the name of either the tli file or
the specific tls file to load:
</p>

<pre class="example">
$ ls /opt/thespian/director
foo-201710261938.tls foo-201710261902.tls foo.tli    sourcekey_tls.key
other-1.3.5          other-1.4            other-2.0  other.tli

$ python -m thespian.director load foo-201710261938.tls

$ python -m thespian.director load foo
</pre>

<p>
Both of the load commands above are equivalent and will load the
indicated tls source into the Thespian ActorSystem.  The load command
will automatically start the Thespian ActorSystem if it is not
currently running.
</p>

<p>
The set of currently loaded and running sources can be retrieved with
the <code>list</code> command:
</p>

<pre class="example">
$ python -m thespian.director list
</pre>

<p>
Each loaded source is described by its group name and also by its hash
value.  The hash value is the same hash value returned by the
<code>ActorSystem().loadSource()</code> function and represents the hash of the
loaded source.
</p>

<p>
The sources can be unloaded as well:
</p>

<pre class="example">
$ python -m thespian.director unload {HASH}
</pre>

<p>
The source associated with the specified hash value is unloaded.
</p>

<p>
To find out what sources are available to be loaded, use the <code>avail</code>
Director command:
</p>

<pre class="example">
$ python -m thespian.director avail
THESPIAN_DIRECTOR_DIR=/opt/thespian/director
foo: /opt/thespian/director/foo-20170261938.tls  4d41d823c3702e9cf7b8b5a650429d7e
   + /opt/thespian/director/foo-20170261902.tls  2a9fcdc7589812b4596f317e85b76042
other: /opt/thespian/director/other-2.0.tls    1bd9df7222c035855babefdfff8f9e29
     + /opt/thespian/director/other-1.4.tls    8406cf8f4596f9cfcae33c7f463bfc1f
     + /opt/thespian/director/other-1.3.5.tls  d9550b9af01692d6a4154cc54cd8d9aa

$
</pre>

<p>
The above shows sample output for the directory contents previously
shown.  It lists each loadable source by group, sorted by version
within the group with the most recent version first and the oldest
version last.  Each line also specifies the hash associated with the
loadable source.
</p>

<p>
To remove a loadable source from consideration for loading, simply
delete it from the <code>THESPIAN_DIRECTOR_DIR</code> directory.
</p>
</div>

<div id="outline-container-org861d176" class="outline-4">
<h4 id="h:6476d6be-5745-47a4-a302-55744fe38d55"><a id="org861d176"></a><span class="section-number-4">2.7.1</span> Loading the latest source versions</h4>
<div class="outline-text-4" id="text-h:6476d6be-5745-47a4-a302-55744fe38d55">
<p>
The Director <code>load</code> command is useful for loading a specific source,
and also automatically selecting the latest source if just the group
name is specified, but for many uses it is normal to load the latest
source load for <b>all</b> groups.
</p>

<p>
To automatically load the latest source for every group, use the
Director <code>refresh</code> command:
</p>

<pre class="example">
$ python -m thespian.director refresh
Loaded "foo" /opt/thespian/director/foo-2017021938.tls: 4d41d823c3702e9cf7b8b5a650429d7e
Loaded "other" /opt/thespian/director/other-2.0.tls    1bd9df7222c035855babefdfff8f9e29

$
</pre>

<p>
As with the <code>load</code> command, the <code>avail</code> command will also startup a
Thespian Actor System if one is not already running.  When the
<code>bootstart</code> command has been used to automatically startup Thespian at
boot time, the boot script will issue the <code>refresh</code> command to start
Thespian and load all of the latest sources.
</p>

<p>
If the latest source for a group is already loaded, the <code>refresh</code> has
no effect on that group.
</p>
</div>
</div>


<div id="outline-container-org160e714" class="outline-4">
<h4 id="h:de4181e6-1c1b-461a-b8b6-bfdd605bf734"><a id="org160e714"></a><span class="section-number-4">2.7.2</span> TLI Files</h4>
<div class="outline-text-4" id="text-h:de4181e6-1c1b-461a-b8b6-bfdd605bf734">
<p>
When loading a loadable source, it is also typical to perform various
startup operations for the source that has been loaded, and it is also
convenient to perform shutdown operations for the previously active
source (loading a new version of a source does not unload the previous
version&#x2014;unless it has been configured to do so&#x2014;but the previous
running instance may still wish to perform shutdown activities).
</p>

<p>
The TLI file that is associated with each group contains the
specification of these startup and shutdown activities.
</p>

<p>
Here is an example of a TLI specification:
</p>

<pre class="example">
$ cat $THESPIAN_DIRECTOR_DIR/foo.tli
{ 'Actors':
    { 'foo.fooactor': 
        { 'OnLoad': { 'Role': 'MainFoo',
                      'Message': 'StartFoo',
                      'GlobalName': 'Foo Primary',
                    },
          'OnReactivate': { 'Message': ('Restart', True) },
          'OnDeactivate': { 'Message': {'Shutdown': True,
                                        'timeout': 3 } },
        },
      'foo.subdir2.barn.cowactor':
        { 'OnLoad': { 'Role': 'FlyingCow',
                      'Message': 'Moo!'
                    },
        },
    },
}

$ cat $THESPIAN_DIRECTOR_DIR/other.tli
{
  'Actors':
    { 'other.mainActor': { 'OnLoad': { 'Role': 'other',
                                       'Message': 0 }}
    }
  'AutoUnload': True,
  'TLS_Keep_Limit': 3,
}

$
</pre>

<p>
The contents of each TLI file is a Python dictionary that is loaded
via a Python <code>eval()</code> statement, where the primary key is "Actors".
The value for that key is another dictionary, whose keys are the
import path specifications of Actors within the loaded source.
</p>

<p>
The value for each of those dictionaries can specify 'OnLoad',
'OnReactivate', and 'OnDeactivate' keys.  When a new loadable source
is loaded, each actor specified is created by the Director, using the
GlobalName (if specified), and sent the specified message (if any).
The "Role" specifies an associated name for that Actor that can be
retrieved with other Director commands.  Both the 'Message' and the
'GlobalName' key are optional.
</p>

<p>
The <code>os</code> module is in effect for the <code>eval()</code> of the TLI file, so it
is possible to pass environment variable values in the messages:
</p>

<pre class="example">
$ cat $THESPIAN_DIRECTOR_DIR/other.tli
{
  'Actors':
    { 'other.mainActor':
      { 'OnLoad':
        { 'Role': 'other',
          'Message': 'Start %s' % os.getenv('OTHER_INFO', 'notspec'),
        },
      }
    }
  'AutoUnload': True,
  'TLS_Keep_Limit': 3,
}
</pre>

<p>
If a previous source was loaded for this group when the new source was
loaded, the previous source is sent the 'Message' specified in the
'OnDeactivate' section (if there is one).  The only recognized element
of the 'OnDeactivate' section is the 'Message' key.  As stated above,
the old source is not necessarily unloaded unless the 'AutoUnload'
primary key is present and its corresponding value is True; the
'OnDeactivate' message is always sent, but the subsequent unload only
occurs in the AutoUnload case.
</p>

<p>
No imports can be performed for this file, so the Message sent can
only be a builtin Python type, or a value from the <code>sys</code> or <code>os</code>
modules.
</p>

<p>
If an old loaded source was superceded by a new loaded source, and
then the new loaded source is subsequently unloaded, the highest
loaded version of the older, still loaded source is re-activated.
When this occurs, the 'OnReactivate' message is sent to the older
source's actor.
</p>

<p>
When the <code>unload</code> Director command is specified, the 'OnDeactivate'
operation will be performed and then the specified Actors will be
sent an <code>ActorExitRequest()</code> message.
</p>

<p>
If the <code>shutdown</code> director command is used, no 'OnDeactivate' message
will be sent and (all) the loaded actors will simply receive the
<code>ActorExitRequest()</code> message.
</p>

<p>
The <code>TLS_Keep_Limit</code> key is also optional, but affects the contents of
the <code>THESPIAN_DIRECTOR_DIR</code> instead of the running Thespian
environment: when a load (or refresh-caused load) has completed, the
Director will determine the number of .tls sources in the
<code>THESPIAN_DIRECTOR_DIR</code> for that group, deleting older files to reduce
the number of loadable sources for that group to the <code>TLS_Keep_Limit</code>.
This allows old loadable source distributions to be automatically
cleaned up and removed.
</p>
</div>
</div>
</div>

<div id="outline-container-org260aa82" class="outline-3">
<h3 id="h:306175d7-4db6-4e47-b035-86efa491b3e0"><a id="org260aa82"></a><span class="section-number-3">2.8</span> Director API</h3>
<div class="outline-text-3" id="text-h:306175d7-4db6-4e47-b035-86efa491b3e0">
<p>
As well as the command-line interface, a Python program can interact
with the Director in two ways:
</p>

<ol class="org-ol">
<li>Exchanging messages to the Director Actor (via
<code>ActorSystem.ask()</code> or another Actor).</li>

<li>Via the DirectorControl object.</li>
</ol>

<p>
In the first form, the source for the director can be examined: there
are documentation strings describing all the messages that can be
exchanged with the Director and the associated responses.  The
Director Actor is registered under the "Director" global name, so an
example of retrieving information about all loaded sources is as follows:
</p>

<pre class="example">
import thespian.actors
asys = ActorSystem()
director_addr = asys.createActor('thespian.director', globalName='Director')
resp = asys.ask(director_addr, { "DirectorOp": "RetrieveAll"})
print(str(resp))
</pre>

<p>
The second alternative is to create an instance of the DirectorControl
object.  Once created, there is a <code>cmd_COMMAND</code> method for each
COMMAND that the Director supports on the command-line, along with
arguments corresponding to the arguments supplied to the command-line
version.  There is also docstring help for each method.
</p>

<pre class="example">
$ THESPIAN_DIRECTOR_DIR=/opt/thespian/director python3
&gt;&gt;&gt; from thespian.director import DirectorControl
&gt;&gt;&gt; dc = DirectorControl()
&gt;&gt;&gt; dc.cmd_avail()
THESPIAN_DIRECTOR_DIR=/opt/thespian/director
foo: /opt/thespian/director/foo-20170261938.tls  4d41d823c3702e9cf7b8b5a650429d7e
   + /opt/thespian/director/foo-20170261902.tls  2a9fcdc7589812b4596f317e85b76042
other: /opt/thespian/director/other-2.0.tls    1bd9df7222c035855babefdfff8f9e29
     + /opt/thespian/director/other-1.4.tls    8406cf8f4596f9cfcae33c7f463bfc1f
     + /opt/thespian/director/other-1.3.5.tls  d9550b9af01692d6a4154cc54cd8d9aa
0
&gt;&gt;&gt; help(dc.cmd_avail)
... docstring information ...
</pre>

<p>
The final <code>0</code> in the above output is the return value from the command
method: command methods will return 0 on success or non-zero on error.
</p>

<p>
There is an additional method: the
<code>DirectorControl.get_role_address('ROLENAME')</code> method, which does not
print any output but returns a dictionary with information about the
currently active Actor associated with the specified Role (as
specified in the TLI file).
</p>

<pre class="example">
$ THESPIAN_DIRECTOR_DIR=/opt/thespian/director python3
&gt;&gt;&gt; from thespian.director import DirectorControl
&gt;&gt;&gt; dc = DirectorControl()
&gt;&gt;&gt; r = dc.get_role_address('MainFoo')
&gt;&gt;&gt; print(r)
{'DirectorResponse': 'RoleAddress',
 'ActorAddress': &lt;thespian.actors.ActorAddress object at 0x7f266ct1d1d0&gt;,
 'Group': 'foo',
 'ActorClass': 'foo.fooactor',
 'SourceHash': '4d41d823c3702e9cf7b8b5a650429d7e',
 'Role': 'MainFoo',
 'Success': True}
&gt;&gt;&gt; r = dc.get_role_address('unknown role name')
RoleAddress ERROR: {'DirectorResponse':'RoleAddress',
                    'ActorAddress': None, 'Role': 'un',
                    'SourceHash': None, 'Group': None,
                    'ActorClass': None, 'Success':False}
&gt;&gt;&gt; print(r)
None
&gt;&gt;&gt; r = dc.get_role_address('unknown role name', silent=True)
&gt;&gt;&gt; print(r)
None
&gt;&gt;&gt;
</pre>

<p>
This method can be used to easily obtain these role-identified actor
addresses to initiate communications with them from an application.
Printing of errors can be suppressed by passing the argument
<code>silent=True</code>, and a <code>group</code> argument can also be specified to limit
the role search to the corresponding group (otherwise all groups are
searched for a role match).
</p>
</div>
</div>
</div>

<div id="outline-container-orge9a52d5" class="outline-2">
<h2 id="h:712ee97c-25b7-4c23-8409-167a2c567bdd"><a id="orge9a52d5"></a><span class="section-number-2">3</span> Considerations for using Loadable Sources</h2>
<div class="outline-text-2" id="text-h:712ee97c-25b7-4c23-8409-167a2c567bdd">
<p>
Loadable sources are a great way to dynamically manage and update one
or more Thespian Actor-based applications, and especially for
installations spanning multiple systems.  There are some limitations
for using this loadable source methodology however.
</p>

<p>
This restriction also applies across loaded source boundaries, but
within a loaded source, target actors can be specified by either
string or class reference.
</p>
</div>

<div id="outline-container-orgf131f38" class="outline-3">
<h3 id="h:1898efa0-a1d4-4415-92e0-8232b2b5285f"><a id="orgf131f38"></a><span class="section-number-3">3.1</span> Source Package limitations</h3>
<div class="outline-text-3" id="text-h:1898efa0-a1d4-4415-92e0-8232b2b5285f">
<p>
Although the <code>loadActorSource()</code> functionality works quite well,
there are a few scenarios that can cause difficulties:
</p>

<ol class="org-ol">
<li>Loaded sources containing or relying on object libraries.  The
<code>loadActorSource()</code> functionality affects the Python module
lookup, but it does not affect object file lookups that would
need to be performed for native object libraries.  In addition,
object libraries are specific to their build environment and may
not work in all target environments.  If the loaded source
simply <b>refers</b> to an externally available library
(e.g. PyOpenSSL python package refers to <code>/usr/lib/libssl.so</code>)
then this may work if the proper object library has been
installed on the target system by other means (i.e. not via the
<code>loadActorSource()</code> call.</li>

<li>Sources containing other PEP302 path importers may not work
correctly when used in conjuction with the <code>loadActorSource()</code>
PEP302 importer.  As an example, the <code>loadActorSource()</code>
importer prefixes loaded modules with the Source Hash associated
with those modules to ensure uniqueness.  This is not always
compatible with other PEP302 importers.

<ol class="org-ol">
<li><p>
The <code>six</code> package (providing Python2/Python3 compatibility)
uses a PEP302 importer to manage moved packages.  This
functionality of the <code>six</code> package is broken by the
<code>loadActorSource()</code> Source Hash prefixing. To avoid this
<code>loadActorSource()</code> processing handles <code>six</code> as a special
case and <i>does not</i> prefix <code>six</code> with any Source Hash.
</p>

<p>
The assumption is that <code>six</code> is a mature and unchanging
package and a global version is acceptable for all loaded
sources (and that a working <code>six</code> importer is preferrable to
a non-working importer).
</p></li>
</ol></li>

<li>The <code>importlib</code> package has a subtle flaw that is not compatible
with the Source Hash prefixing performed by <code>loadActorSource()</code>.
To work around this problem Thespian provides an updated version
of <code>importlib</code>; use " <code>import thespian.importlib as importlib</code> "
instead of just " <code>import importlib</code> " in Actor sources that
will be loaded via <code>loadActorSource()</code>.</li>

<li>Loaded sources should expect that <code>__file__</code> or other internals
can be set to None.</li>

<li>It is not possible to send internally-defined objects between
sources (see <a href="#h:423373f2-9638-4b96-80a5-a57abe94f134">Communication across package boundaries</a> below).</li>

<li>The loadable source can only contain pure Python code, including
all dependencies.  If there are dependencies that have
associated C object extensions or other binary-specific
components, those must be pre-installed and accessed via the
normal fashion and not included as a dependency in the loadable
source package.</li>
</ol>
</div>
</div>

<div id="outline-container-orgac7734e" class="outline-3">
<h3 id="h:1e8b3963-5daa-4ea5-9067-25bde3580b80"><a id="orgac7734e"></a><span class="section-number-3">3.2</span> Logging callables not supported</h3>
<div class="outline-text-3" id="text-h:1e8b3963-5daa-4ea5-9067-25bde3580b80">
<p>
The Python <code>logging</code> library has the ability to configure callable
objects to provide various formatter capabilities.  Since the
<code>thesplog.cfg</code> file must define only a Python dictionary and not
executable code, that file cannot contain any callable objects.
</p>

<p>
If a callable object was needed for logging, it would need to be
installed on the target systems (along with Thespian) prior to
starting up Thespian.  As long as the callable target is a valid
import path for the context in which Thespian is started, it can then
be used.
</p>
</div>
</div>

<div id="outline-container-orga65fc4f" class="outline-3">
<h3 id="h:423373f2-9638-4b96-80a5-a57abe94f134"><a id="orga65fc4f"></a><span class="section-number-3">3.3</span> Communication across package boundaries</h3>
<div class="outline-text-3" id="text-h:423373f2-9638-4b96-80a5-a57abe94f134">
<p>
By default, Thespian uses the pickle module to send messages from
one actor to another.  This requires that the unpickling operation
in the target Actor's environment be able to reconstitute the
pickled object by name.  
</p>

<p>
When using loadable sources, all names are prefixed with the hash
value of the source they have come from, thereby creating a private
namespace for each loaded source.  Actors within the same loaded
source will share the same hash and can use internally created
class objects to communicate, but that they will not be able to do
this when communicating with Actors in other loaded sources (or the
external environment).  This means that all messages exchanged with
Actors across a loaded source boundary must be regular, built-in
Python objects (strings, numbers, booleans, tuples, lists,
dictionaries, etc.), or a standardized format such as JSON.
</p>

<p>
If there is an attempt to send an internal source-loaded object
across this boundary, a deserialization error will be written to
the logfile for the destination actor, but it will not even be able
to generate a PoisonMessage response because it cannot parse the
message to determine the sender.
</p>
</div>
</div>

<div id="outline-container-orgd38fb0e" class="outline-3">
<h3 id="h:29d0f65c-db9f-4d8c-893b-0711958ed792"><a id="orgd38fb0e"></a><span class="section-number-3">3.4</span> Actor specifications for createActor</h3>
<div class="outline-text-3" id="text-h:29d0f65c-db9f-4d8c-893b-0711958ed792">
<p>
When using the <code>ActorSystem().createActor()</code> method, the Actor to be
created must be specified by the fully module-qualified string name of
the Actor instead of the class reference.
</p>

<p>
The following two will <b>not</b> work:
</p>

<pre class="example">
import foo
fail1 = ActorSystem().createActor(foo.fooActor.FooActor)

from foo.fooActor import FooActor
fail2 = ActorSystem().createActor(FooActor)
</pre>

<p>
however, the following will work correctly:
</p>

<pre class="example">
good_addr = ActorSystem().createActor('foo.fooActor.FooActor', ...)
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Kevin Quick &lt;quick@sparq.org&gt;</p>
<p class="date">Created: 2021-05-26 Wed 18:14</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
